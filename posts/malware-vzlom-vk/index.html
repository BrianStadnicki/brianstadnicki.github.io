<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' utteranc.es; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' utteranc.es static.cloudflareinsights.com; prefetch-src 'self'; connect-src 'self' cloudflareinsights.com;"><meta name=author content="Brian Stadnicki"><meta name=description content="Malware obtained from any.run. It&rsquo;s an unknown executable which unpacks itself, fails to run update.exe and prints out some russian.
   Property Value     MD5 18b065e37c55a00d7a023f5cef02bde4   SHA1 fb6e6596c617f932cd9c7740b29ed6f5dda8a88c   SHA256 bc4896abbf0726df8b9ef9134d584bbe1b649f59e453bbc327f8cd5b5b5a0651   File Type Portable Executable 32   File Info Microsoft Visual C++ 8    First run    When run, it prints out the following text:"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Analysis of vzlom_vk (Failed)"><meta name=twitter:description content="Malware obtained from any.run. It&rsquo;s an unknown executable which unpacks itself, fails to run update.exe and prints out some russian.
   Property Value     MD5 18b065e37c55a00d7a023f5cef02bde4   SHA1 fb6e6596c617f932cd9c7740b29ed6f5dda8a88c   SHA256 bc4896abbf0726df8b9ef9134d584bbe1b649f59e453bbc327f8cd5b5b5a0651   File Type Portable Executable 32   File Info Microsoft Visual C++ 8    First run    When run, it prints out the following text:"><meta property="og:title" content="Analysis of vzlom_vk (Failed)"><meta property="og:description" content="Malware obtained from any.run. It&rsquo;s an unknown executable which unpacks itself, fails to run update.exe and prints out some russian.
   Property Value     MD5 18b065e37c55a00d7a023f5cef02bde4   SHA1 fb6e6596c617f932cd9c7740b29ed6f5dda8a88c   SHA256 bc4896abbf0726df8b9ef9134d584bbe1b649f59e453bbc327f8cd5b5b5a0651   File Type Portable Executable 32   File Info Microsoft Visual C++ 8    First run    When run, it prints out the following text:"><meta property="og:type" content="article"><meta property="og:url" content="https://brianstadnicki.github.io/posts/malware-vzlom-vk/"><meta property="article:published_time" content="2021-11-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-09T00:00:00+00:00"><title>Analysis of vzlom_vk (Failed) · Brian Stadnicki</title><link rel=canonical href=https://brianstadnicki.github.io/posts/malware-vzlom-vk/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.8e2b2510f60e1715eae08d113a808dcdaf17f6f711edb9e969be38d0074d240d.css integrity="sha256-jislEPYOFxXq4I0ROoCNza8X9vcR7bnpab440AdNJA0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.c70a5bbf9c7e831f99d04251fb0cea5cfd006fbb5a9776a53198938516b3a9c9.css integrity="sha256-xwpbv5x+gx+Z0EJR+wzqXP0Ab7tal3alMZiThRazqck=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.80.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Brian Stadnicki</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/quips/>Quips</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://brianstadnicki.github.io/posts/malware-vzlom-vk/>Analysis of vzlom_vk (Failed)</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-11-09T00:00:00Z>9 November, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>4-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i><a href=/categories/malware/>malware</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i><span class=tag><a href=/tags/reverse-engineering/>reverse engineering</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/malware/>malware</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/russian/>russian</a></span></div></div></header><div><p>Malware obtained from <a href=https://app.any.run/tasks/75439b32-753f-4d1c-b4d3-ee36a4605de1/>any.run</a>. It&rsquo;s an unknown executable which unpacks itself, fails to run <code>update.exe</code> and prints out some russian.</p><table><thead><tr><th>Property</th><th>Value</th></tr></thead><tbody><tr><td>MD5</td><td>18b065e37c55a00d7a023f5cef02bde4</td></tr><tr><td>SHA1</td><td>fb6e6596c617f932cd9c7740b29ed6f5dda8a88c</td></tr><tr><td>SHA256</td><td>bc4896abbf0726df8b9ef9134d584bbe1b649f59e453bbc327f8cd5b5b5a0651</td></tr><tr><td>File Type</td><td>Portable Executable 32</td></tr><tr><td>File Info</td><td>Microsoft Visual C++ 8</td></tr></tbody></table><h1 id=first-run>First run
<a class=heading-link href=#first-run><i class="fa fa-link" aria-hidden=true></i></a></h1><p>When run, it prints out the following text:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>The system cannot find the file update.exe
﻿Вас приветствует программа взлома ВК аккаунтов!
Благодарим за приобретение лицензии нашей программы!
Вы уверенны, что хотите начать? (да/нет):
</code></pre></div><p>Using the trusty google translator, that turns into:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>You are welcomed by the program for hacking VK accounts!
Thank you for purchasing our software license!
Are you sure you want to start? (yes / no):
</code></pre></div><p>This appears to be a tool for hacking <a href=https://vk.com/>VK</a> accounts, which is &ldquo;the largest social network in Russia and the CIS&rdquo;. This is also a cracked version, seeing how I definitely don&rsquo;t own a license.</p><p>When I enter <code>y</code>, the following shows up:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Введите id жертвы:
</code></pre></div><p>Translated, that means:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Enter victim id:
</code></pre></div><p>So, here is a hacking tool for VK accounts and it asks for a victim ID, now who do I not like in Russia&mldr; I&rsquo;ll just put 0.</p><p>Now it prints out</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Загрузка...
</code></pre></div><p>which means</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Loading...
</code></pre></div><p>Next is a progress bar, which gets up to 25%, followed by a python error:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Traceback (most recent call last):
  File &#34;vzlom_vk.py&#34;, line 21, in &lt;module&gt;
FileNotFoundError: [WinError 2] The system cannot find the file specified &#39;update.exe&#39;
[1548] Failed to execute script vzlom_vk
</code></pre></div><p>Later I&rsquo;ll focuse on trying to extracting this python script.</p><h1 id=unpacking>Unpacking
<a class=heading-link href=#unpacking><i class="fa fa-link" aria-hidden=true></i></a></h1><p>Detect It Easy provides very useful information about how the executable is packed:</p><table><thead><tr><th>Property</th><th>Value</th></tr></thead><tbody><tr><td>Protector</td><td>ENIGMA(4.0 build 2020.5.17 10:10:13)[-]</td></tr><tr><td>Linker</td><td>Microsoft Linker(8.0*)[Console32,console]</td></tr><tr><td>Overlay</td><td>zlib archive(-)[-]</td></tr></tbody></table><p>To dump this, I will quite simply run the malware and use <a href=https://github.com/glmcdona/Process-Dump>Process Dump</a>, pointing it to the process ID of the child of the malware.</p><h1 id=dumped-executable-initial-analysis>Dumped executable initial analysis
<a class=heading-link href=#dumped-executable-initial-analysis><i class="fa fa-link" aria-hidden=true></i></a></h1><p>Just from looking at strings, there are multiple things we can infer:</p><table><thead><tr><th>String</th><th>Inference</th></tr></thead><tbody><tr><td>Py_*</td><td>Python C api used</td></tr><tr><td>inflate 1.2.11 Copyright 1995-2017 Mark Adler</td><td>Zlib compression used</td></tr><tr><td>Fls*</td><td>Fiber Local Storage (FLS) used</td></tr><tr><td>Software\Borland\Delphi\RTL</td><td>Delphi (Locales) used</td></tr><tr><td>RIJNDAEL</td><td>AES encryption used</td></tr><tr><td>Yarrow has not been reseeded</td><td>Yarrow pseudorandom number generator used</td></tr><tr><td>EP_*</td><td>Engima Protector keys are validated</td></tr><tr><td>9iCCPPhotoshop ICC profile</td><td>Photoshop colour profiles are referenced</td></tr><tr><td>IEUser MSEDGEWIN10</td><td>Dumps are fingerprinted</td></tr></tbody></table><p>It&rsquo;s very likely that most of these details are related to the ENIGMA packer.</p><h1 id=files-dynamically-written>Files dynamically written
<a class=heading-link href=#files-dynamically-written><i class="fa fa-link" aria-hidden=true></i></a></h1><p>The unpacked exe extracts resources into <code>C:\Users\IEUser\AppData\Local\Temp\_MEI5562</code>, where there are: python extension modules, library dlls, locale files and tkinter. However, the script <code>vzlom_vk.py</code> is missing.</p><p>Near the end of the procmon log, I find the following entry:</p><p><code>vzlom_vk.exe 994 CreateFile C:\Users\IEUser\AppData\Local\Temp\_MEI5562\vzlom_vk.py</code></p><p>However, this file is never written to, therefore this is not in fact the location of the python script, but rather the location the python process thinks its at because in reality the script was loaded in dynamically through the python C api.</p><h1 id=python-extraction>Python extraction
<a class=heading-link href=#python-extraction><i class="fa fa-link" aria-hidden=true></i></a></h1><p>Based off the python C api <a href=https://docs.python.org/3/c-api>documentation</a>, the following used methods are of interest for finding the code which is dynamically executed:</p><ul><li><a href=https://docs.python.org/3/c-api/veryhigh.html#c.PyEval_EvalCode>PyEval_EvalCode</a></li><li><a href=https://docs.python.org/3/c-api/call.html#c.PyObject_Call>PyObject_CallFunction</a></li><li><a href="https://docs.python.org/3/c-api/import.html?highlight=pyimport_execcodemodule#c.PyImport_ExecCodeModule">PyImport_ExecCodeModule</a></li><li><a href="https://docs.python.org/3/c-api/sys.html?highlight=pysys_setpath#c.PySys_SetPath">PySys_SetPath</a></li></ul><p>All of these imports are referenced at least once in the same function.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>0x1032900:

       +------+
       |Import|
       +-+--+-+
         |  |
+------+ |  | +-------+
| Fail &lt;-+  +-+&gt;Import|
+------+      +--+--+-+
                 |  |
        +------+ |  | +------+
        | Fail &lt;-+  +-&gt;Import|
        +------+      +-+--+-+
                        |  |
               +------+ |  | +------+
               | Fail &lt;-+  +-&gt;Import|
               +------+      +-+--+-+
                               |  |
                      +------+ |  | +------+
                      | Fail &lt;-+  +-&gt;Import|
                      +------+      +-+--+-+
                                      |  |
                             +------+ |  | +------+
                             | Fail &lt;-+  +-&gt;Import|
                             +------+      +-+--+-+
                                             |  |
                                    +------+ |  | +-------+
                                    | Fail &lt;-+  +-+&gt;Import|
                                    +------+      +--+--+-+
                                                     |  |
                                            +------+ |  |
                                            | Fail &lt;-+  +-&gt;.......
                                            +------+
</code></pre></div><p>This function simply populates all of the python imports.</p><p>Here are the xrefs to <code>PyEval_EvalCode</code>:</p><table><thead><tr><th>Type</th><th>Address</th><th>Text</th></tr></thead><tbody><tr><td>r</td><td>python_executor+160</td><td>call ds:PyEval_EvalCode</td></tr><tr><td>w</td><td>get_python_imports+4DB</td><td>mov ds:PyEval_EvalCode, eax</td></tr><tr><td>o</td><td>.nicuew:013F3420</td><td>dd rva PyEval_EvalCode; Import Address Table</td></tr></tbody></table><p>Based off this, we can identify that <code>python_executor</code> is responsible for python code calling at least partially.</p><h1 id=pyinstaller>PyInstaller
<a class=heading-link href=#pyinstaller><i class="fa fa-link" aria-hidden=true></i></a></h1><p>I spotted the string <code>_MEIPASS2</code>, which after some googling turns out is an environment variable for PyInstaller. Therefore, let&rsquo;s see if this can be extracted using the <a href=https://github.com/extremecoders-re/pyinstxtractor>PyInstaller Extractor</a></p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>struct.error: unpack requires a buffer of 4 bytes
</code></pre></div><p>Always worthy a try to use pre-existing tools, even if they don&rsquo;t often work out.</p><h1 id=pyinstaller-files>PyInstaller files
<a class=heading-link href=#pyinstaller-files><i class="fa fa-link" aria-hidden=true></i></a></h1><p>Let&rsquo;s take a look again at the files which were dynamically written.</p><p>The <code>.pyd</code> files are simply dlls.</p><h1 id=failure>Failure
<a class=heading-link href=#failure><i class="fa fa-link" aria-hidden=true></i></a></h1><p>I ran <code>strings</code> to try to find where <code>__main__</code> could possibly be. Debugging didn&rsquo;t reveal what the script actually is. Python dumpers don&rsquo;t seem to exist.</p><p>Therefore, until I learn more about python reverse engineering through more reverse engineering, this project will be put on hold.</p></div><footer><script src=https://utteranc.es/client.js repo=brianstadnicki/brianstadnicki.github.io issue-term=pathname label theme=preferred-color-scheme crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container><p>Education through a 1000 mistakes</p>©
2021
Brian Stadnicki
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.a350362441276ec5c1671926420497bb8e52b63ead1d51d3c9bc4342d0039526.js integrity="sha256-o1A2JEEnbsXBZxkmQgSXu45Stj6tHVHTybxDQtADlSY="></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "f5dd1cc794e748f0a1fa431f62434694"}'></script></body></html>