<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' utteranc.es; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' utteranc.es static.cloudflareinsights.com; prefetch-src 'self'; connect-src 'self' cloudflareinsights.com;">
<meta name=author content="Brian Stadnicki">
<meta name=description content=".docx and .doc documents can contain embedded objects through a variety of methods, here we look at a sample using OLE linking and embedding.
Sample obtained from any.run
   Property Value     File Type Rich Text Format   File Size 8.00 KB   FileTitle OriginalRTF.bak.rtf   MD5 00f576ddeaf60756bfe671858434931c   SHA1 44c0d585482755dd945cea10458b82ca6cb620ff   SHA256 23c8f0fb9912538eee0bde49b2007e7e0f4efbd8bca69ddb9c05fafcee6f03ab    Initial static analysis    {\rt{\object\objemb\objw1\objh1{\*\objclass Package}{\*\objdata 01050000020000000800.">
<meta name=keywords content="blog,developer,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Embedded objects in OLE & OLE2 using links">
<meta name=twitter:description content=".docx and .doc documents can contain embedded objects through a variety of methods, here we look at a sample using OLE linking and embedding.
Sample obtained from any.run
   Property Value     File Type Rich Text Format   File Size 8.00 KB   FileTitle OriginalRTF.bak.rtf   MD5 00f576ddeaf60756bfe671858434931c   SHA1 44c0d585482755dd945cea10458b82ca6cb620ff   SHA256 23c8f0fb9912538eee0bde49b2007e7e0f4efbd8bca69ddb9c05fafcee6f03ab    Initial static analysis    {\rt{\object\objemb\objw1\objh1{\*\objclass Package}{\*\objdata 01050000020000000800.">
<meta property="og:title" content="Embedded objects in OLE & OLE2 using links">
<meta property="og:description" content=".docx and .doc documents can contain embedded objects through a variety of methods, here we look at a sample using OLE linking and embedding.
Sample obtained from any.run
   Property Value     File Type Rich Text Format   File Size 8.00 KB   FileTitle OriginalRTF.bak.rtf   MD5 00f576ddeaf60756bfe671858434931c   SHA1 44c0d585482755dd945cea10458b82ca6cb620ff   SHA256 23c8f0fb9912538eee0bde49b2007e7e0f4efbd8bca69ddb9c05fafcee6f03ab    Initial static analysis    {\rt{\object\objemb\objw1\objh1{\*\objclass Package}{\*\objdata 01050000020000000800.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://brianstadnicki.github.io/posts/malware-ole-ole2-embed-links/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-03T00:00:00+00:00">
<meta property="article:modified_time" content="2021-12-03T00:00:00+00:00">
<title>
Embedded objects in OLE & OLE2 using links · Brian Stadnicki
</title>
<link rel=canonical href=https://brianstadnicki.github.io/posts/malware-ole-ole2-embed-links/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css integrity="sha256-cIaG+KuBdukdRPy+SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.91.2">
</head>
<body class="preload-transitions colorscheme-light">
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Brian Stadnicki
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/about/>About</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/contact/>Contact me</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://brianstadnicki.github.io/posts/malware-ole-ole2-embed-links/>
Embedded objects in OLE & OLE2 using links
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2021-12-03T00:00:00Z>
3 December, 2021
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read
</span>
</div>
<div class=categories>
<i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/malware-analysis/>malware analysis</a></div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/reverse-engineering/>reverse engineering</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/malware/>malware</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/word/>word</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/rtf/>rtf</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/ole/>ole</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/ole2/>ole2</a>
</span></div>
</div>
</header>
<div>
<p><img src=/posts/malware-ole-ole2-embed-links/preview.png alt=Preview></p>
<p>.docx and .doc documents can contain embedded objects through a variety of methods, here we look at a sample using OLE linking and embedding.</p>
<p>Sample obtained from <a href=https://app.any.run/tasks/0e904df7-aced-4309-a172-dcf85d463b6e/>any.run</a></p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>File Type</td>
<td>Rich Text Format</td>
</tr>
<tr>
<td>File Size</td>
<td>8.00 KB</td>
</tr>
<tr>
<td>FileTitle</td>
<td>OriginalRTF.bak.rtf</td>
</tr>
<tr>
<td>MD5</td>
<td>00f576ddeaf60756bfe671858434931c</td>
</tr>
<tr>
<td>SHA1</td>
<td>44c0d585482755dd945cea10458b82ca6cb620ff</td>
</tr>
<tr>
<td>SHA256</td>
<td>23c8f0fb9912538eee0bde49b2007e7e0f4efbd8bca69ddb9c05fafcee6f03ab</td>
</tr>
</tbody>
</table>
<h1 id=initial-static-analysis>
Initial static analysis
<a class=heading-link href=#initial-static-analysis>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>{\rt{\object\objemb\objw1\objh1{\*\objclass Package}{\*\objdata 01050000020000000800...
}}{\object\objautlink\objupdate{\*\objclass Word.Document.8}{\*\objdata 01050...
</code></pre></div><p>You can see <code>Word.Document.8</code> being used to embed a word document object. You can read up on how objects are embedded in RTF documents and OLE Exploits on the <a href=https://www.mcafee.com/blogs/other-blogs/mcafee-labs/an-inside-look-into-microsoft-rich-text-format-and-ole-exploits/>McAfee blog</a></p>
<h1 id=extracting-the-word-document>
Extracting the word document
<a class=heading-link href=#extracting-the-word-document>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h1>
<p>Initially I tried to use <a href=https://github.com/decalage2/oletools/wiki/rtfobj>rtfobj</a>, but I ran up against <a href=https://github.com/decalage2/oletools/issues/712>issue 712</a>, but there&rsquo;s a fix from <a href=https://github.com/zdiff/oletools/tree/bugfix/538>zdiff</a>.</p>
<p>The following were extracted from the .rtf:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>---+----------+---------------------------------------------------------------
id |index     |OLE Object                                                     
---+----------+---------------------------------------------------------------
0  |0000003Fh |format_id: 2 (Embedded)                                        
   |          |class name: b&#39;Package&#39;                                         
   |          |data size: 619                                                 
   |          |OLE Package object:                                            
   |          |Filename: &#39;QNV32ZJJYHRAJI9.sct&#39;                                
   |          |Source path: &#39;C:\\fakepath\\QNV32ZJJYHRAJI9.sct&#39;               
   |          |Temp path = &#39;C:\\fakepath\\QNV32ZJJYHRAJI9.sct&#39;                
   |          |MD5 = &#39;4c8ef666ff36eb0780dc4cfa7941a7de&#39;                       
   |          |EXECUTABLE FILE                                                
---+----------+---------------------------------------------------------------
1  |000005ADh |format_id: 2 (Embedded)                                        
   |          |class name: b&#39;OLE2Link&#39;                                        
   |          |data size: 2560                                                
   |          |MD5 = &#39;ca72599a87f0d00eacd954ce96390459&#39;                       
   |          |CLSID: 00000300-0000-0000-C000-000000000046                    
   |          |StdOleLink (embedded OLE object - Known Related to             
   |          |CVE-2017-0199, CVE-2017-8570, CVE-2017-8759 or CVE-2018-8174)  
   |          |Possibly an exploit for the OLE2Link vulnerability (VU#921560, 
   |          |CVE-2017-0199)                                                 
---+----------+---------------------------------------------------------------
</code></pre></div><h2 id=embedded-qnv32zjjyhraji9sct>
embedded QNV32ZJJYHRAJI9.sct
<a class=heading-link href=#embedded-qnv32zjjyhraji9sct>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>This <code>.sct</code> scriptlet simply runs <code>calc.exe</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;script language=&#34;JScript&#34;&gt;
&lt;![CDATA[
    var r = new ActiveXObject(&#34;WScript.Shell&#34;).Run(&#34;calc.exe&#34;);
]]&gt;
&lt;/script&gt;
</code></pre></div><h2 id=embedded-ole-object>
embedded OLE object
<a class=heading-link href=#embedded-ole-object>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>This is a OLE object, specifically a <code>Word.Document.8</code>, which is the Word 97 version. To analyse this older document type, use <a href=https://blog.didierstevens.com/programs/oledump-py/>oledump</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ python3 oledump.py OriginalRTF.bak.rtf_object_000005AD.bin&#39;
  1:       256 &#39;\x01Ole&#39;
  2:       183 &#39;\x03LinkInfo&#39;
  3:         6 &#39;\x03ObjInfo&#39;
b$ python3 oledump.py -s1 OriginalRTF.bak.rtf_object_000005AD.bin
00000000: 01 00 00 02 09 00 00 00  01 00 00 00 00 00 00 00  ................
00000010: 00 00 00 00 00 00 00 00  C0 00 00 00 09 03 00 00  ................
00000020: 00 00 00 00 C0 00 00 00  00 00 00 46 02 00 00 00  ...........F....
00000030: 03 03 00 00 00 00 00 00  C0 00 00 00 00 00 00 46  ...............F
00000040: 00 00 1A 00 00 00 25 54  4D 50 25 5C 51 4E 56 33  ......%TMP%\QNV3
00000050: 32 5A 4A 4A 59 48 52 41  4A 49 39 2E 73 63 74 00  2ZJJYHRAJI9.sct.
00000060: 0E 00 AD DE 00 00 00 00  00 00 00 00 00 00 00 00  ................
00000070: 00 00 00 00 00 00 00 00  38 00 00 00 32 00 00 00  ........8...2...
00000080: 03 00 25 00 54 00 4D 00  50 00 25 00 5C 00 51 00  ..%.T.M.P.%.\.Q.
00000090: 4E 00 56 00 33 00 32 00  5A 00 4A 00 4A 00 59 00  N.V.3.2.Z.J.J.Y.
000000A0: 48 00 52 00 41 00 4A 00  49 00 39 00 2E 00 73 00  H.R.A.J.I.9...s.
000000B0: 63 00 74 00 C6 AF AB EC  19 7F D2 11 97 8E 00 00  c.t.............
000000C0: F8 75 7E 2A 00 00 00 00  00 00 00 00 00 00 00 00  .u~*............
000000D0: 00 00 00 00 00 00 00 00  00 00 00 00 FF FF FF FF  ................
000000E0: 06 09 02 00 00 00 00 00  C0 00 00 00 00 00 00 46  ...............F
000000F0: 00 00 00 00 FF FF FF FF  00 00 00 00 00 00 00 00  ................
$ python3 oledump.py -s2 OriginalRTF.bak.rtf_object_000005AD.bin
# Bunch of 0s
$ python3 oledump.py -s3 OriginalRTF.bak.rtf_object_000005AD.bin
00000000: 90 66 60 A6 37 B5                                 .f`.7.
</code></pre></div><p>This just runs the scriptlet from earlier.</p>
</div>
<footer>
<script src=https://utteranc.es/client.js repo=brianstadnicki/brianstadnicki.github.io issue-term=pathname label theme=preferred-color-scheme crossorigin=anonymous async></script>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
<p>Education through a 1000 mistakes</p>
©
2021 -
2022
Brian Stadnicki
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
</section>
</footer>
</main>
<script src=/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js integrity="sha256-A7F3afT5GuNWZ+HyocqMFvUFYlds+Q/zKzF5kmkU2qU="></script>
<script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "f5dd1cc794e748f0a1fa431f62434694"}'></script>
</body>
</html>